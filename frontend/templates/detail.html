<style>
    /* --- PC端默认样式 --- */
    .detail-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: transparent; cursor: pointer; }
    .right-slide-panel {
        position: absolute; top: 90px; right: -600px; bottom: 20px; width: 500px;
        background: #fff; box-shadow: -10px 0 40px rgba(0,0,0,0.1);
        border-top-left-radius: 24px; border-bottom-left-radius: 24px;
        z-index: 2001; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column; border: 1px solid #F1F5F9; overflow: hidden;
    }
    .right-slide-panel.open { right: 0; }
    .map-header { height: 220px; background: url('/static/assets/map.jpg') center/cover; position: relative; flex-shrink: 0; }
    .close-btn-circle { width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: absolute; top: 20px; left: 20px; z-index: 5; }
    .panel-content { flex: 1; padding: 30px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    
    /* [核心修改] 通用底部按钮栏样式 */
    .panel-footer { 
        padding: 20px 30px; 
        border-top: 1px solid #F1F5F9; 
        background: #fff;
        /* 默认网格布局，适应 [联系][操作] 的双按钮模式 */
        display: grid;
        grid-template-columns: 1fr 1.5fr; 
        gap: 15px;
        flex-shrink: 0;
    }
    /* 单按钮模式 (如"接单") */
    .panel-footer.single-btn { display: block; }
    
    .panel-footer .btn { height: 50px !important; font-size: 16px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    /* 次要按钮样式 (联系) */
    .btn-secondary-outline { background: #fff; border: 2px solid #E2E8F0; color: #4A5568; }
    /* 危险按钮样式 (取消) */
    .btn-danger { background: #EF4444; color: white; }

    /* [核心修改] PC端聊天窗口位置调整 */
    .chat-float-window {
        position: fixed; 
        bottom: 180px; /* [修改] 提高到底部悬浮栏上方 */
        right: 520px;
        width: 380px; height: 500px; background: #fff; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        z-index: 2005; display: none; flex-direction: column; overflow: hidden; border: 1px solid #E2E8F0; animation: popUp 0.3s;
    }

    /* 移动端适配 */
    @media screen and (max-width: 768px) {
        .right-slide-panel { top: 0 !important; bottom: 0 !important; width: 100% !important; border-radius: 0 !important; right: -100% !important; z-index: 10000 !important; }
        .right-slide-panel.open { right: 0 !important; }
        .map-header { height: 200px !important; }
        .panel-content { padding: 20px; }
        .panel-footer { padding: 15px 20px 100px 20px !important; }
        .chat-float-window { position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100% !important; height: 100% !important; border-radius: 0 !important; z-index: 30000 !important; box-shadow: none !important; border: none !important; display: none; }
        .chat-float-window[style*="display: block"], .chat-float-window[style*="display: flex"] { display: flex !important; }
        .chat-footer { padding-bottom: max(20px, env(safe-area-inset-bottom)) !important; }
    }

    @keyframes popUp { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .chat-header { background: #1A202C; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .chat-body { flex: 1; background: #F8FAFC; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .chat-footer { padding: 10px; background: #fff; border-top: 1px solid #EDF2F7; display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
    .msg { max-width: 80%; padding: 8px 12px; border-radius: 10px; font-size: 13px; word-break: break-all; }
    .msg.left { align-self: flex-start; background: #fff; border: 1px solid #E2E8F0; color: #2D3748; }
    .msg.right { align-self: flex-end; background: #3182CE; color: #fff; }
    .msg img { max-width: 100%; border-radius: 5px; }
    .rating-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 30005 !important; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .rating-card { background: #fff; width: 320px; padding: 30px; border-radius: 24px; text-align: center; animation: popUp 0.4s; }
    @media (max-width: 768px) { .rating-card { width: 85%; } }
    .star-rating { display: flex; justify-content: center; gap: 10px; margin: 20px 0; font-size: 24px; color: #CBD5E0; cursor: pointer; }
    .star-rating i.active { color: #F59E0B; }
</style>

<div class="detail-backdrop" onclick="closeDetail()"></div>
<div class="right-slide-panel" id="detail-panel">
    <div class="map-header">
        <div class="close-btn-circle" onclick="closeDetail()"><i class="fas fa-times" style="color: #333;"></i></div>
        <div style="position: absolute; bottom: 20px; left: 20px; right: 20px; background: #fff; padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
            <div><div style="font-size: 12px; color: #718096;">距离目的地</div><div style="font-size: 20px; font-weight: 800; color: #1A202C;">200m</div></div>
            <div style="background: #EDF2F7; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;" id="panel-status-badge">...</div>
        </div>
    </div>
    <div class="panel-content">
        <h2 id="panel-title" style="font-size: 22px; font-weight: 800; color: #1A202C; margin-bottom: 5px;">--</h2>
        <div style="font-size: 13px; color: #A0AEC0; margin-bottom: 25px;">订单号 #<span id="panel-id">--</span></div>
        <div style="background: #F8FAFC; padding: 20px; border-radius: 16px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 14px; color: #64748B; font-weight: 600;">本单赏金</div>
            <div style="font-size: 28px; font-weight: 800; color: #3182CE; font-family: 'DIN Alternate', sans-serif;" id="panel-price">¥--</div>
        </div>
        <div style="margin-bottom: 10px; font-size: 14px; font-weight: 700; color: #4A5568;">订单追踪</div>
        <div class="timeline">
            <div class="timeline-item active">
                <div style="position: absolute; left: 0; top: 5px; width: 14px; height: 14px; border-radius: 50%; background: #3182CE; border: 3px solid #fff; box-shadow: 0 0 0 1px #CBD5E0;"></div>
                <div style="padding-left: 25px; font-size: 14px; font-weight: 700; color: #1A202C;">订单已发布</div>
                <div style="padding-left: 25px; font-size: 12px; color: #718096;" id="time-create">--</div>
            </div>
            <div class="timeline-item" id="track-taken" style="margin-top: 20px;">
                <div style="position: absolute; left: 0; top: 5px; width: 14px; height: 14px; border-radius: 50%; background: #CBD5E0; border: 3px solid #fff;"></div>
                <div style="padding-left: 25px; font-size: 14px; font-weight: 700; color: #A0AEC0;">已被接单</div>
                <div style="padding-left: 25px; font-size: 12px; color: #A0AEC0;" id="time-taken">待接单</div>
            </div>
            <div class="timeline-item" id="track-done" style="margin-top: 20px;">
                <div style="position: absolute; left: 0; top: 5px; width: 14px; height: 14px; border-radius: 50%; background: #CBD5E0; border: 3px solid #fff;"></div>
                <div style="padding-left: 25px; font-size: 14px; font-weight: 700; color: #A0AEC0;">送达目的地</div>
                <div style="padding-left: 25px; font-size: 12px; color: #A0AEC0;" id="time-done">待送达</div>
            </div>
        </div>
        <div id="extra-info-box" style="margin-top: 20px; padding: 10px; background: #FFF5F5; color: #C53030; border-radius: 8px; font-size: 13px; display: none;"></div>
    </div>
    <div class="panel-footer" id="panel-actions"></div>
</div>

<div class="chat-float-window" id="chat-window">
    <div class="chat-header">
        <div style="display:flex; align-items:center; gap:8px;"><div style="width:8px; height:8px; background:#48BB78; border-radius:50%;"></div><span style="font-weight:600; font-size:14px;">沟通中</span></div>
        <i class="fas fa-chevron-down" style="cursor: pointer; opacity: 0.8;" onclick="document.getElementById('chat-window').style.display='none'"></i>
    </div>
    <div class="chat-body" id="chat-history"></div>
    <div class="chat-footer">
        <input type="file" id="img-upload" hidden accept="image/*">
        <i class="fas fa-image" style="color:#A0AEC0; font-size: 20px; cursor: pointer; padding: 0 5px;" onclick="document.getElementById('img-upload').click()"></i>
        <input type="text" id="chat-input" placeholder="输入消息..." style="flex:1; border:none; background:#F1F5F9; padding:8px 12px; border-radius:20px; outline:none; font-size:14px;">
        <button onclick="sendMessage()" style="width:36px; height:36px; border-radius:50%; background:#3182CE; color:#fff; border:none; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div class="rating-modal" id="ratingModal">
    <div class="rating-card">
        <div style="width: 50px; height: 50px; background: #F0FFF4; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;"><i class="fas fa-check" style="color: #48BB78; font-size: 24px;"></i></div>
        <h3 style="font-size: 18px; font-weight: 800; color: #1A202C;">订单已完成</h3>
        <p style="font-size: 13px; color: #718096; margin-top: 5px;">给同学打个分吧！</p>
        <div class="star-rating" id="star-container">
            <i class="fas fa-star active" data-val="1"></i><i class="fas fa-star active" data-val="2"></i><i class="fas fa-star active" data-val="3"></i><i class="fas fa-star active" data-val="4"></i><i class="fas fa-star active" data-val="5"></i>
        </div>
        <button class="btn btn-submit btn-block" onclick="submitRating()" style="background: #0F172A; color: white;">提交评价</button>
    </div>
</div>
<input type="hidden" id="hidden-order-id" value="{{ order_id }}">